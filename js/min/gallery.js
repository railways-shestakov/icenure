function ftg_getURLParameter(name){return decodeURIComponent((new RegExp("[?|&]"+name+"=([^&;]+?)(&|#|;|$)").exec(location.search)||[,""])[1].replace(/\+/g,"%20"))||null}var qualifyURL=function(url){var img=document.createElement("img");return img.src=url,url=img.src,img.src=null,url};!function($,window,document,undefined){$.fn.visible=function(partial){if(!$(this).offset())return!0;var $t=$(this),$w=$(window),viewTop=$w.scrollTop(),viewBottom=viewTop+$w.height(),_top=$t.offset().top,_bottom=_top+$t.height();return(!0===partial?_top:_bottom)<=viewBottom&&(!0===partial?_bottom:_top)>=viewTop};var pluginName="finalTilesGallery",defaults={layout:"final",columns:[[4e3,5],[1024,4],[800,3],[480,2],[320,1]],rowHeight:200,margin:10,minTileWidth:200,ignoreImageAttributes:!0,imageSizeFactor:[[4e3,.9],[1024,.8],[800,.7],[600,.6],[480,.5],[320,.3]],gridSize:10,disableGridSizeBelow:800,allowEnlargement:!0,autoLoadURL:null,selectedFilter:"",onComplete:function(){},onUpdate:function(){},onLoading:function(){},debug:!1};function Plugin(element,options){
/*! properties */
this.element=element,this.$element=$(element),this.settings=$.extend({},defaults,options),this._columnSize=0,this._defaults=defaults,this._name=pluginName,this.tiles=[],this._loadedImages=0,this._rows=[[]],this._currentRow=0,this._currentRowTile=0,this.edges=[],this.imagesData={},this.currentWidth=0,this.currentImageSizeFactor=1,this.currentColumnsCount=0,this.currentGridSize=0,this.ajaxComplete=!1,this.isLoading=!1,this.currentPage=1,this.init()}$.extend(Plugin.prototype,{print:function(text){this.settings.debug&&console.log(text)},setCurrentImageSizeFactor:function(){this.currentImageSizeFactor=1;for(var ww=$(window).width(),i=0;i<this.settings.imageSizeFactor.length;i++)this.settings.imageSizeFactor[i][0]>=ww&&(this.currentImageSizeFactor=this.settings.imageSizeFactor[i][1]);this.currentImageSizeFactor||(this.currentImageSizeFactor=1),this.print("current image size factor: "+this.currentImageSizeFactor+" ("+ww+")")},setCurrentColumnSize:function(){for(var ww=$(window).width(),i=0;i<this.settings.columns.length;i++)this.settings.columns[i][0]>=ww&&(this.currentColumnsCount=this.settings.columns[i][1]);this._columnSize=(this.currentWidth-this.settings.margin*(this.currentColumnsCount-1))/this.currentColumnsCount,this.print(this.currentWidth,this._columnSize)},setCurrentGridSize:function(){this.currentWidth<this.settings.disableGridSizeBelow?this.currentGridSize=0:this.currentGridSize=this.settings.gridSize*this.currentImageSizeFactor,this.print(this.currentGridSize),console.log(this.currentGridSize)},init:function(){var instance=this,current_filter=this.settings.selectedFilter;if((filter_url=ftg_getURLParameter("ftg-set"))&&(current_filter=filter_url),instance.currentWidth=instance.$element.width(),0==instance.$element.filter(":visible").length)return instance.print("cannot initialize the gallery, container is hidden. Retrying in 500ms."),void setTimeout((function(){instance.init()}),500);this.$element.find(".ftg-items").css({position:"relative"});var filter_url;current_filter=this.settings.selectedFilter;(filter_url=ftg_getURLParameter("ftg-set"))&&(current_filter=filter_url);instance=this;null!=current_filter&&(instance.print(".. found filter ("+current_filter+")"),instance.$element.find(".ftg-filters a").removeClass("selected"),instance.$element.find(".ftg-filters a").each((function(){$(this).data("filter")==current_filter&&(instance.print(".. selecting filter"),$(this).addClass("selected"))})));var hash=window.location.hash;if(this.$element.find(".ftg-items").css({position:"relative",minWidth:instance.settings.minTileWidth}),hash&&"#ftg-set-ftgall"!=hash&&"#ftg-set"==hash.substr(0,8)||instance.settings.selectedFilter){var ft="#ftg-set-"+instance.settings.selectedFilter;hash&&(ft=hash);var hash_class=ft.replace("#","."),filters=[];instance.$element.find(".ftg-filters a").each((function(){filters.push($(this).attr("href"))})),$.inArray(ft,filters)>=0&&(hash_class=hash_class.substring(1),instance.$element.find(".ftg-filters a").each((function(){$(this).attr("href")!=ft&&(instance.$element.find(".item").each((function(){var img=$(this).parent().parent();0==img.hasClass(hash_class)&&img.addClass("ftg-hidden-tile")})),$(this).removeClass("selected"))})),$('a[href="'+ft+'"]').addClass("selected"))}this.tiles=this.$element.find(".tile").not(".ftg-hidden-tile"),this.currentWidth=this.$element.width(),this.print("this.currentWidth: "+this.currentWidth),"columns"!=this.settings.layout&&"rows"!=this.settings.layout&&"final"!=this.settings.layout&&console.log("WARNING: unknown layout, falling back to 'final'."),"columns"==this.settings.layout&&this.setCurrentColumnSize();var _resizeTo=0;this.setCurrentImageSizeFactor(),this.setCurrentGridSize(),$(window).resize((function(){_resizeTo=setTimeout((function(){instance.currentWidth!=instance.$element.width()&&(clearTimeout(_resizeTo),instance.print("this.currentWidth",this.currentWidth),instance.currentWidth=instance.$element.width(),instance.setCurrentColumnSize(),instance.setCurrentImageSizeFactor(),instance.setCurrentGridSize(),instance.refresh())}),500)})),instance.isLoading=!0,instance.settings.autoLoadURL&&$(window).scroll((function(){instance.ajaxComplete||instance.isLoading||instance.tiles.last().visible()&&(instance.isLoading=!0,instance.settings.onLoading&&instance.settings.onLoading(),$.post(instance.settings.autoLoadURL,{page:++instance.currentPage,action:"load_chunk",pageSize:instance.settings.pageSize,finaltilesgallery:instance.settings.nonce,gallery:instance.settings.galleryId},(function(html){0==$.trim(html).length?instance.ajaxComplete=!0:(instance.$element.find(".ftg-items").append(html),instance.tiles=instance.$element.find(".tile"),instance.loadImage())})))})),this.setupFilters(),this.edges.push({left:0,top:0,width:this.currentWidth,index:0}),this.loadImage()},addElements:function(html){this.$element.find(".ftg-items").append(html),this.tiles=this.$element.find(".tile"),this.loadImage()},removeAt:function(index){this.tiles[index].remove(),this.refresh()},clear:function(){this.$element.find(".ftg-items").height(0).empty(),this.refresh()},setupFilters:function(){var instance=this;instance.$element.find(".ftg-filters a").click((function(e){e.preventDefault(),instance.$element.find(".ftg-filters a").removeClass("selected"),$(this).addClass("selected");var ft=$(this).attr("href").replace("#ftg-set-","");"ftgall"==ft?(instance.$element.find(".tile").removeClass("ftg-hidden-tile"),instance.$element.find(".tile a").addClass("everlightbox-trigger")):(instance.$element.find(".everlightbox-trigger").removeClass("everlightbox-trigger"),instance.$element.find(".tile").not(".ftg-set-"+ft).addClass("ftg-hidden-tile").end().filter(".ftg-set-"+ft).removeClass("ftg-hidden-tile"),instance.$element.find(".ftg-set-"+ft+" a").addClass("everlightbox-trigger")),instance.refresh()}))},printEdges:function(){for(this.$element.find(".edge").remove(),i=0;i<this.edges.length;i++){var $e=$("<div class='edge' />");$e.append("top: "+this.edges[i].top+"<br>"),$e.append("left: "+this.edges[i].left+"<br>"),$e.append("width: "+this.edges[i].width+"<br>"),$e.css({left:this.edges[i].left,top:this.edges[i].top,marginTop:-25,marginLeft:20}),this.$element.append($e)}},printEdge:function(edge){var $e=$("<div class='edge enlarged-"+edge.enlarged+"' />");$e.append("<b>"+edge.index+" "+edge.case+"</b><br>"),$e.append("t: "+Math.round(edge.top)+" l: "+edge.left+"<br>"),$e.append("width: "+edge.width+"<br>"),$e.append("idx: "+edge.tileIndex+"<br>"),$e.css({left:edge.left,top:edge.top,marginTop:-25,marginLeft:20}),this.$element.append($e)},refresh:function(){this.$element.find(".edge").remove(),this.edges=[{left:0,top:0,width:this.currentWidth}],this.tiles.removeClass("ftg-loaded ftg-enlarged"),this.tiles=this.$element.find(".tile").not(".ftg-hidden-tile"),this._loadedImages=0,this.loadImage()},getAvailableRowSpace:function(){return this.currentWidth-this.getBusyRowSpace()},getBusyRowSpace:function(){for(var space=0,i=0;i<this._rows[this._currentRow].length;i++)space+=this._rows[this._currentRow][i].data("width")+this.settings.margin;return space},addImageToRow:function($img){console.log(this._rows),console.log(this._currentRow),this._rows[this._currentRow].push($img)},fitImagesInRow:function(){this.getAvailableRowSpace(),this.settings.margin;for(var ratio=(this.currentWidth-(this._rows[this._currentRow].length-1)*this.settings.margin)/this.getBusyRowSpace(),i=0;i<this._rows[this._currentRow].length;i++){$item=this._rows[this._currentRow][i];var w=$item.data("width");$item.data("height");$item.data("width",w*ratio),this.add(this._currentRowTile++)}},nextTile:function(add){if(add&&this.add(this._loadedImages),++this._loadedImages<this.tiles.length)this.loadImage();else{var height=this.lowerEdgeTop();this.print("lower edge top: "+height),this.$element.find(".ftg-items").height(height),this.isLoading=!1,this.settings.onComplete()}},
/*! loadImage */
loadImage:function(){var instance=this,$tile=this.tiles.eq(this._loadedImages);$tile.find("iframe").length&&$tile.find("iframe").addClass("item");var $item=$tile.find(".item");switch($item.get(0).tagName.toLowerCase()){case"img":var img=new Image;img.onload=function(){var iFactor=instance.currentImageSizeFactor;$tile.data("ftg-ignore-size-factor")&&(iFactor=1);var size={},addImage=!0;if("final"==instance.settings.layout){var w=$item.attr("width")?parseInt($item.attr("width")):img.width,h=$item.attr("height")?parseInt($item.attr("height")):img.height;size.width=w*iFactor,size.height=h*iFactor}"columns"==instance.settings.layout&&(size.width=instance._columnSize,size.height=size.width*img.height/img.width),"rows"==instance.settings.layout&&(size.width=instance.settings.rowHeight*img.width/img.height,size.height=instance.settings.rowHeight,addImage=!1,instance.getAvailableRowSpace()>size.width||(instance.fitImagesInRow(),instance._currentRow++,instance._rows.push([])),instance.addImageToRow($item)),$item.attr("src",this.src),instance.imagesData["tile"+instance._loadedImages]={width:size.width,height:size.height,owidth:img.width,oheight:img.height,src:img.src},instance.nextTile(addImage)},img.onerror=function(){instance.print("error loading image: "+img.src),instance.nextTile(!0)},img.src=$item.data("ftg-src"),$tile.data("ftg-type","image");break;case"iframe":var w=$item.attr("width")?parseInt($item.attr("width")):$item.data("width"),h=$item.attr("height")?parseInt($item.attr("height")):$item.data("height"),size={width:w,height:h,owidth:w,oheight:h};"columns"==instance.settings.layout&&(size.width=instance._columnSize,size.height=size.width*size.oheight/size.owidth),instance.imagesData["tile"+instance._loadedImages]=size,$tile.data("ftg-type","iframe"),instance.nextTile(!0);break;default:instance.imagesData["tile"+instance._loadedImages]={width:parseInt($item.data("width")),height:parseInt($item.data("height")),owidth:parseInt($item.data("width")),oheight:parseInt($item.data("height"))},instance.nextTile(!0)}},higherEdge:function(){for(var _top=1e5,found=0,i=0;i<this.edges.length;i++)this.edges[i].top<_top&&(found=i,_top=this.edges[i].top);return this.edges[found]},lowerEdgeTop:function(){for(var min=0,i=0;i<this.edges.length;i++)this.edges[i].top>min&&(min=this.edges[i].top);return min},alignEdge:function(edge,index){for(var i=0;i<this.edges.length;i++)if(this.edges[i].left+this.edges[i].width+this.settings.margin==edge.left&&(this.print("found edge on left",i),edge.top==this.edges[i].top))return this.print("edges can be aligned [1]"),{side:"left",edge:this.edges[i]};for(i=0;i<this.edges.length;i++)if(this.edges[i].left-this.settings.margin==edge.left+edge.width&&(this.print("found edge on right",i),edge.top==this.edges[i].top))return this.print("edges can be aligned [2]"),{side:"right",edge:this.edges[i]};return null},removeEdge:function(edge){for(var tmp=[],i=0;i<this.edges.length;i++)this.edges[i]!=edge&&tmp.push(this.edges[i]);this.edges=tmp},add:function(tileIndex){var $t=this.tiles.eq(tileIndex),$item=$t.find(".item"),key="tile"+tileIndex,w=this.imagesData[key].width,h=this.imagesData[key].height,hEdge=this.higherEdge();if(this.print(hEdge),hEdge.tileIndex=tileIndex,this.print(tileIndex+" ["+$t.data("ftg-type")+"] ("+w+"x"+h+")"),this.print("hEdge.width: "+hEdge.width),hEdge.top>0&&(hEdge.top+=this.settings.margin),$t.css({left:hEdge.left,top:hEdge.top,position:"absolute"}),hEdge.enlarged=!1,hEdge.width<w+this.settings.margin){hEdge.case="Te",this.print("Te");var h2=h/w*(w2=hEdge.width);w2+hEdge.left-this.settings.margin==this.currentWidth&&(this.print("END"),h2=h/w*(w2-=this.settings.margin)),w=w2,h=h2}else if(hEdge.width>=w)if(this.print("tE"),"columns"==this.settings.layout||hEdge.width-w>=this.settings.minTileWidth){hEdge.case="tE",this.print("tE1",hEdge.width,hEdge.left,this.currentWidth);var newEdge={left:hEdge.left+w+this.settings.margin,top:hEdge.top-(hEdge.top>0?this.settings.margin:0),width:hEdge.width-w-this.settings.margin,marginLeft:!0,case:"NEW",index:hEdge.index+1};this.edges.push(newEdge)}else{hEdge.case="tE2",this.print("tE2"),this.print("enlargement",hEdge.width,hEdge.left,this.currentWidth);hEdge.left+hEdge.width==this.currentWidth||this.settings.margin;var w2=hEdge.width;h2=this.settings.allowEnlargement&&"rows"!=this.settings.layout?h/w*w2:h;this.settings.allowEnlargement?($t.addClass("ftg-enlarged"),hEdge.enlarged=!0):"rows"!=this.settings.layout&&$t.find(".item").css({width:w,height:h}),w=w2,h=h2}if(hEdge.top+=h,this.currentGridSize){var diff=hEdge.top%this.currentGridSize;hEdge.top-=diff,h-=diff}hEdge.left=hEdge.left,hEdge.width=w;var printEdge=!0,aligned=this.alignEdge(hEdge,tileIndex);aligned&&("left"==aligned.side?(this.removeEdge(hEdge),aligned.edge.width+=w+this.settings.margin,h-=hEdge.top-aligned.edge.top,hEdge.top-=h,printEdge=!1):(this.removeEdge(aligned.edge),hEdge.width+=this.settings.margin+aligned.edge.width,printEdge=!1),$t.height(h)),this.$element.find(".ftg-items").height()<hEdge.top&&this.$element.find(".ftg-items").height(hEdge.top),this.settings.debug&&printEdge&&this.printEdge(hEdge),"iframe"==$t.data("ftg-type")&&$t.find("iframe").height(h),this.print(w+"x"+h),this.print("----"),$t.css({width:w,height:h});$t.css("transition");$t.css({display:"block",transform:"scale(1)"});var ratio=w/this.imagesData[key].width,hdiff=this.imagesData[key].height*ratio-h;"iframe"!=$t.data("ftg-type")&&$item.css({height:"auto"}),hdiff>0&&$item.css({top:0-hdiff/2}),$t.addClass("ftg-loaded")}}),$.fn[pluginName]=function(options){return this.each((function(){$.data(this,pluginName)||$.data(this,pluginName,new Plugin(this,options))})),this},$((function(){$(".ftg-social a").click((function(e){e.preventDefault();var social=$(this).data("social"),$tile=$(this).parents(".tile").first(),image=$tile.data("big");image||(image=$tile.find(".item").attr("src"));var text=$.trim($tile.find(".subtitle").text());text.length||(text=document.title);var desc=$.trim($tile.find(".title").text());if(desc.length||(desc=document.title),"facebook"==social){var url="https://www.facebook.com/dialog/feed?app_id=1447224948871585&link="+encodeURIComponent(location.href)+"&display=popup&name="+encodeURIComponent(desc)+"&caption=&description="+encodeURIComponent(text)+"&picture="+encodeURIComponent(qualifyURL(image))+"&ref=share&actions={%22name%22:%22View%20the%20gallery%22,%20%22link%22:%22"+encodeURIComponent(location.href)+"%22}&redirect_uri=http://www.final-tiles-gallery.com/facebook_redirect.html";window.open(url,"ftgw","location=1,status=1,scrollbars=1,width=600,height=400").moveTo(screen.width/2-300,screen.height/2-200)}"twitter"==social&&window.open("https://twitter.com/intent/tweet?url="+encodeURI(location.href.split("#")[0])+"&text="+encodeURI(desc+" "+text),"ftgw","location=1,status=1,scrollbars=1,width=600,height=400").moveTo(screen.width/2-300,screen.height/2-200);if("pinterest"==social){url="http://pinterest.com/pin/create/button/?url="+encodeURIComponent(location.href)+"&description="+encodeURI(desc+" "+text);url+="&media="+encodeURIComponent(qualifyURL(image)),window.open(url,"ftgw","location=1,status=1,scrollbars=1,width=600,height=400").moveTo(screen.width/2-300,screen.height/2-200)}if("google-plus"==social){url="https://plus.google.com/share?url="+encodeURI(location.href);window.open(url,"ftgw","location=1,status=1,scrollbars=1,width=600,height=400").moveTo(screen.width/2-300,screen.height/2-200)}}))}))}(jQuery,window,document);