{% set currentYear = "now"|date("Y") %}
{% set totalArticles = posts|length %}
{% set years = [] %}
{% set quartileQ1 = [] %}
{% set quartileQ2 = [] %}
{% set quartileQ12 = [] %}
{% set quartileQ1Len = 0 %}
{% set quartileQ2Len = 0 %}
{% set quartileQ12Len = 0 %}

{% for publication in posts %}
    {% set year = publication.get_field('year') %}
    {% set quartile = publication.get_field('quartile')|default('') %}
    {% set normalizedQuartile = quartile|upper|replace({'\\':'/'}) %}

    {% if normalizedQuartile == 'Q1' %}
        {% set quartileQ1Len = quartileQ1Len + 1 %}
        {% set quartileQ12Len = quartileQ12Len + 1 %}
    {% elseif normalizedQuartile == 'Q2' %}
        {% set quartileQ2Len = quartileQ2Len + 1 %}
        {% set quartileQ12Len = quartileQ12Len + 1 %}
    {% endif %}

    {% set nextPublication = posts[loop.index0 + 1]|default(null) %}
    {% set nextyear = nextPublication ? nextPublication.get_field('year') : 0 %}

    {% if nextyear != year %}
        {% set years = years|merge([year]) %}
        {% set quartileQ1 = quartileQ1|merge([quartileQ1Len]) %}
        {% set quartileQ2 = quartileQ2|merge([quartileQ2Len]) %}
        {% set quartileQ12 = quartileQ12|merge([quartileQ12Len]) %}

        {% set quartileQ1Len = 0 %}
        {% set quartileQ2Len = 0 %}
        {% set quartileQ12Len = 0 %}
    {% endif %}
{% endfor %}

<h1 class="main__title main__title--aside">
    {{ title }}
    <div class="main__subtitle">
        Усього {{ totalArticles }} {{ function('get_wordform', totalArticles, 'стаття', 'статті', 'статей') }}
    </div>
</h1>

<section>
    {% if years|length > 0 %}
        <div class="main__block main__chart">
            <canvas id="cursor" width="730px" height="203px"></canvas>
            <canvas id="publicationChart" width="100" height="40"></canvas>
        </div>
    {% endif %}
    <div class="main__block main__page">

        {# итерация от текущего года до 2000 #}
        {% for year in currentYear..2000 %}
            {% set articles = [] %}
            {% set reports = [] %}

            {# внутренний цикл: выбираем публикации с совпадающим годом #}
            {% for publication in posts %}
                {% set pubYear = publication.get_field('year') %}
                {% if pubYear == year %}
                    {% set type = publication.get_field('type') %}
                    {% if type == 'Стаття' %}
                        {% set articles = articles|merge([publication]) %}
                    {% else %}
                        {% set reports = reports|merge([publication]) %}
                    {% endif %}
                {% endif %}
            {% endfor %}

            {# если за этот год есть публикации — выводим #}
            {% if articles|length > 0 or reports|length > 0 %}
                <div class="title">
                    {{ year }} {{ function('get_translation', 'рік', 'year') }}
                </div>

                {% for item in articles %}
                    {% set authors = item.get_field('authors') %}
                    {% set text = item.text %}
                    {% set wos = item.wos %}
                    {% set scopus = item.scopus %}
                    {% set doi = item.doi %}
                    {% set quartile = item.quartile %}

                    <div class='publication'>
                        <div class='publication--authors'>
                            {{ loop.index }}. {{ authors }}
                            {% if scopus %}
                                <div class='tag tag--blue'>Scopus</div>
                            {% endif %}
                            {% if wos %}
                                <div class='tag tag--blue'>WoS</div>
                            {% endif %}
                            {% if quartile %}
                                <div class='tag tag--green'>{{ quartile }}</div>
                            {% endif %}
                            {% if doi %}
                                <div class='tag tag--brown'>
                                    DOI
                                    <a href='{{ doi }}' target='_blank' rel='nofollow'></a>
                                </div>
                            {% endif %}
                        </div>
                        <div class='publication--text'>
                            {{ text }}
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        {% endfor %}
    </div>
</section>

{% if years|length > 0 %}
<script>
Chart.defaults.global.defaultFontSize = 14;
Chart.defaults.global.defaultFontColor = '#2F536D';
Chart.defaults.global.defaultFontFamily = 'Montserrat';
let ctx = document.getElementById('publicationChart').getContext('2d');
window.chart = new Chart(ctx, {
  type: 'bar',
  data: {
    labels: [{{ years|reverse|join(',') }}],
    datasets: [
        {
            data: [{{ quartileQ1|reverse|join(',') }}],
            label: "Q1",
            borderColor: "#1C7C54",
            pointBackgroundColor: "#1C7C54",
            pointHoverBackgroundColor: "#1C7C54",
            backgroundColor: "#1C7C54",
            pointHoverRadius: 5,
            fill: false
        },
        {
            data: [{{ quartileQ2|reverse|join(',') }}],
            label: "Q2",
            borderColor: "#EF6F6C",
            pointBackgroundColor: "#EF6F6C",
            pointHoverBackgroundColor: "#EF6F6C",
            backgroundColor: "#EF6F6C",
            pointHoverRadius: 5,
            fill: false
        },
        {
            data: [{{ quartileQ12|reverse|join(',') }}],
            label: "Q1/Q2",
            borderColor: "#F4B942",
            pointBackgroundColor: "#F4B942",
            pointHoverBackgroundColor: "#F4B942",
            backgroundColor: "#F4B942",
            pointHoverRadius: 5,
            fill: false
        }
    ],
  },
  options: {
    responsive: true,
    title: {
      display: true,
      text: 'Статистика публікацій за роками',
      fontSize: 16
    },
    tooltips: {
      mode: 'label',
      intersect: false
    },
    legend: {
        align: 'start',
        position: 'bottom',
        labels: {
            fontSize: 14,
            usePointStyle: true,
            boxWidth: 10,
        }
    },
    scales: {
        yAxes: [
            {
                ticks: {
                    precision: 0,
                },
            },
        ],
    }
  }
});

{% if dark_mode %}
    Chart.defaults.global.defaultFontColor = '#ffffff';
    let yAxes = chart.options.scales.yAxes;
    let xAxes = chart.options.scales.xAxes;

    for(let key in yAxes){
        yAxes[key].gridLines.zeroLineColor = 'rgba(255,255,255,.25)';
        yAxes[key].gridLines.color = 'rgba(255,255,255,.1)';
    }

    for(let key in xAxes){
        xAxes[key].gridLines.zeroLineColor = 'rgba(255,255,255,.25)';
        xAxes[key].gridLines.color = 'rgba(255,255,255,.1)';
    }
{% endif %}

$(document).ready(function(){
    $('#publicationChart').on("mousemove", function(e) {
        let element = $("#cursor");
                let domElement = element[0];
        let offsetLeft = domElement.getBoundingClientRect().left;
                let clientX = (e.clientX - offsetLeft);
                let ctx = domElement.getContext('2d');

        ctx.clearRect(0, 0, domElement.width, domElement.height);
        ctx.beginPath();
        ctx.moveTo(clientX, 0);
        ctx.lineTo(clientX, domElement.height);
        ctx.lineWidth = 2;
        ctx.strokeStyle = "#E5E5E5";
        ctx.stroke();
    });
});
</script>
{% endif %}
