
{% set pat = [] %}
{% set patSum = 0 %}
{% set years = [] %}

{% for patent in posts %}
    {% set year = patent.get_field('year') %}

    {% if year not in years %}
        {% set years = years|merge([year]) %}
    {% endif %}

    {% set patSum = patSum + 1 %}

    {% if pat['y'~year] %}
        {% set patCount = pat['y'~year] %}
    {% else %}
        {% set patCount = 0 %}
    {% endif %}

    {% set patCount = patCount + 1 %}

    {% set name = 'y' ~ year %}
    {% set pat = pat|merge({ (name): (patCount)}) %}
{% endfor %}

<h1 class="main__title main__title--aside">
   {{title}}
   
   <div class='main__subtitle'>
        Усього оформлено {{ patSum }} {{function('get_wordform', patSum, 'патент', 'патенти', 'патентів' )}}
   </div>
</h1>

<section>
    <div class="main__block main__chart">
        <canvas id="cursor" width="730px" height="203px"></canvas>
        <canvas id="publicationChart" width="100" height="40" ></canvas>
    </div>

    {% for year in years %}
        {% set link = function('get_translation', '/ua', '/en') ~ '/patents/' ~ year %}

        {% set patLen = pat['y' ~ year] %}

        <div class="main__block">
            <div class="row">
                <div>
                    <div class="row__name">
                        <a href='{{link}}'>
                            Патенти за {{year}} рік
                        </a>
                    </div>
                    <div class="row__content">
                        У {{year}} році оформлено
                        {{patLen == 0 ? " взагалі нічого" : ""}}{{
                            patLen
                            ? patLen ~ " " ~ function('get_wordform', patLen, 'патент', 'патенти', 'патентів')
                            : ""
                        }}.
                    </div>
                </div>
            </div>
            
        </div>
    {% endfor %}
</section>

{% set patarr = [] %}

{% for year in years %}
    {% set name = 'y' ~ year %}
    {% set patarr = patarr|merge({ (name): (pat['y'~year])}) %}
{% endfor %}

<script>
Chart.defaults.global.defaultFontSize = 14;
Chart.defaults.global.defaultFontColor = '#2F536D';
Chart.defaults.global.defaultFontFamily = 'Montserrat';
let ctx = document.getElementById('publicationChart').getContext('2d');
window.chart = new Chart(ctx, {
  type: 'bar',
  data: {
    labels: [{{years|reverse|join(',')}}],
    datasets: [
        { 
            data: [{{pat|reverse|join(',')}}],
            label: "Патенти",
            borderColor: "#3e95cd",
            pointBackgroundColor: "#3e95cd",
            pointHoverBackgroundColor: "#3e95cd",
            backgroundColor: "#3e95cd",
            pointHoverRadius: 5,
            fill: false
        }
    ],
  },
  options: {
    responsive: true,
    title: {
      display: true,
      text: 'Статистика оформлення патентів за роками',
      fontSize: 16
    },
    tooltips: {
      mode: 'label',
      intersect: false
    },
    legend: {
        align: 'start',
        position: 'bottom',
        labels: {
            fontSize: 14,
            usePointStyle: true,
            boxWidth: 10,
        }
    },
    scales: {
        yAxes: [
            {
                ticks: {
                    precision: 0,
                    min: 0,
                    max: 10,
                },
            },
        ],
    }
  }
});

{% if dark_mode %}
    Chart.defaults.global.defaultFontColor = '#ffffff';
    let yAxes = chart.options.scales.yAxes;
    let xAxes = chart.options.scales.xAxes;

    for(let key in yAxes){
        yAxes[key].gridLines.zeroLineColor = 'rgba(255,255,255,.25)';
        yAxes[key].gridLines.color = 'rgba(255,255,255,.1)';
    }

    for(let key in xAxes){
        xAxes[key].gridLines.zeroLineColor = 'rgba(255,255,255,.25)';
        xAxes[key].gridLines.color = 'rgba(255,255,255,.1)';
    }
{% endif %}

$(document).ready(function(){
    $(document).on("mousemove", function(e) {
        let element = $("#cursor");
		let domElement = element[0];
        let offsetLeft = domElement.getBoundingClientRect().left;
		let clientX = (e.clientX - offsetLeft);
		let ctx = domElement.getContext('2d');
        
        ctx.clearRect(0, 0, domElement.width, domElement.height);
        ctx.beginPath();
        ctx.moveTo(clientX, 0);
        ctx.lineTo(clientX, domElement.height);
        ctx.lineWidth = 2;
        ctx.strokeStyle = "#E5E5E5";
        ctx.stroke();
    });
});
</script>